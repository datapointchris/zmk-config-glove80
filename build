#!/bin/bash

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Building Glove80 firmware...${NC}"
echo -e "${YELLOW}Using Moergo's ZMK fork via west build${NC}"

if ! command -v docker >/dev/null 2>&1; then
    echo -e "${RED}Error: Docker not found. Please install Docker to build firmware.${NC}"
    exit 1
fi

ZMK_CONFIG_PATH="$(pwd)"

# Check timestamps before build
lh_old_ts=""
rh_old_ts=""
if [ -f "glove80_lh.uf2" ]; then
    lh_old_ts=$(stat -f "%m" glove80_lh.uf2)
fi
if [ -f "glove80_rh.uf2" ]; then
    rh_old_ts=$(stat -f "%m" glove80_rh.uf2)
fi

# Create/recreate the zmk-config volume as a bind mount
echo -e "${YELLOW}Setting up zmk-config volume as bind mount...${NC}"
docker volume ls | grep -q zmk-config && docker volume rm zmk-config >/dev/null 2>&1 || true
docker volume create --driver local \
  -o o=bind \
  -o type=none \
  -o device="$ZMK_CONFIG_PATH" \
  zmk-config

echo -e "${YELLOW}Building with Docker...${NC}"

docker run --rm \
  -v zmk-config:/workspaces/zmk-config \
  -w /workspaces/zmk-config \
  zmkfirmware/zmk-build-arm:3.5-branch \
  /bin/bash -c "
    # Initialize west workspace from config/west.yml
    if [ ! -f .west/config ]; then
      west init -l config/
    fi
    west update

    echo 'Building Glove80 left half...'
    west build -s zmk/app -d build/glove80_lh -p -b glove80_lh -- \
      -DZMK_CONFIG=/workspaces/zmk-config/config
    cp build/glove80_lh/zephyr/zmk.uf2 glove80_lh.uf2

    echo 'Building Glove80 right half...'
    west build -s zmk/app -d build/glove80_rh -p -b glove80_rh -- \
      -DZMK_CONFIG=/workspaces/zmk-config/config
    cp build/glove80_rh/zephyr/zmk.uf2 glove80_rh.uf2

    echo 'Glove80 firmware built successfully!'
  "

# Verify files were created and timestamps changed
if [ -f "glove80_lh.uf2" ] && [ -f "glove80_rh.uf2" ]; then
    lh_new_ts=$(stat -f "%m" glove80_lh.uf2)
    rh_new_ts=$(stat -f "%m" glove80_rh.uf2)
    lh_human=$(stat -f "%Sm" glove80_lh.uf2)
    rh_human=$(stat -f "%Sm" glove80_rh.uf2)
    if [ "$lh_new_ts" = "$lh_old_ts" ] || [ "$rh_new_ts" = "$rh_old_ts" ]; then
        echo -e "${RED}Glove80 build failed or did not update UF2 files. Timestamp unchanged.${NC}"
        echo -e "LH: $lh_human | RH: $rh_human"
        exit 1
    fi
    echo -e "${GREEN}Glove80 firmware built successfully:${NC}"
    echo "LH UF2: $lh_human"
    echo "RH UF2: $rh_human"
    ls -lh glove80_*.uf2
else
    echo -e "${RED}Glove80 build failed - no output files found${NC}"
    exit 1
fi
